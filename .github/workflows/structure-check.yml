name: Repository Structure Check

on:
  pull_request:
  push:
    branches: [main, develop]

jobs:
  check-structure:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check for loose files in root
        run: |
          echo "üîç Checking repository structure..."

          # Allowed files in root directory
          ALLOWED_ROOT_FILES=(
            "Dockerfile"
            "LICENSE"
            "Makefile"
            "README.md"
            "requirements.txt"
            "docker-compose.yml"
            "docker-compose.monitoring.yml"
            ".gitignore"
            ".dockerignore"
            ".env.example"
            ".pre-commit-config.yaml"
            ".readthedocs.yaml"
            ".secrets.baseline"
          )

          # Get all files in root (exclude directories and hidden files)
          ROOT_FILES=$(ls -1 | grep -v "/$" | grep -v "^\.")

          # Check each file
          VIOLATIONS=0
          for file in $ROOT_FILES; do
            if [[ ! " ${ALLOWED_ROOT_FILES[@]} " =~ " ${file} " ]]; then
              echo "‚ùå Loose file in root: $file"
              echo "   ‚Üí Should be moved to appropriate subfolder"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done

          # Check for common misplaced files
          if [ -f "best_hyperparameters.json" ]; then
            echo "‚ùå best_hyperparameters.json should be in config/ml/"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          if [ -f "training_output.log" ]; then
            echo "‚ùå training_output.log should be in logs/"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          if [ -f "*.md" ] && [ "$file" != "README.md" ] && [ "$file" != "LICENSE" ]; then
            echo "‚ùå Documentation files should be in docs/"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          # Report results
          if [ $VIOLATIONS -gt 0 ]; then
            echo ""
            echo "‚ùå Found $VIOLATIONS structure violations!"
            echo ""
            echo "üìÅ Correct structure:"
            echo "   ‚Ä¢ Documentation ‚Üí docs/"
            echo "   ‚Ä¢ Config files ‚Üí config/"
            echo "   ‚Ä¢ Scripts ‚Üí scripts/"
            echo "   ‚Ä¢ Logs ‚Üí logs/"
            echo "   ‚Ä¢ Source code ‚Üí src/"
            echo ""
            echo "Run: ./scripts/cleanup_repo.sh to fix automatically"
            exit 1
          else
            echo "‚úÖ Repository structure is clean!"
          fi
