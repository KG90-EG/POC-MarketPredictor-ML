name: Repository Structure Check

on:
  pull_request:
  push:
    branches: [main, develop]

jobs:
  check-structure:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check for loose files in root
        run: |
          echo "üîç Checking repository structure..."

          # Allowed files in root directory
          ALLOWED_ROOT_FILES=(
            "Dockerfile"
            "LICENSE"
            "Makefile"
            "README.md"
            "requirements.txt"
            "docker-compose.yml"
            "docker-compose.monitoring.yml"
            ".gitignore"
            ".dockerignore"
            ".env.example"
            ".pre-commit-config.yaml"
            ".readthedocs.yaml"
            ".secrets.baseline"
            "CHANGELOG_2026-01-11.md"
            "best_hyperparameters.json"
            "pyproject.toml"
            "pytest.ini"
            "backtest"
            "training"
          )

          # Allowed directories in root
          ALLOWED_ROOT_DIRS=(
            "src"
            "frontend"
            "tests"
            "docs"
            "scripts"
            "config"
            "data"
            "models"
            "logs"
            "mlruns"
            "monitoring"
            "archive"
            "examples"
            ".github"
            ".husky"
            ".vscode"
            ".idea"
          )

          # Get only FILES in root (not directories, not hidden)
          ROOT_FILES=$(find . -maxdepth 1 -type f ! -name ".*" -exec basename {} \;)

          # Check each file
          VIOLATIONS=0
          for file in $ROOT_FILES; do
            if [[ ! " ${ALLOWED_ROOT_FILES[@]} " =~ " ${file} " ]]; then
              echo "‚ùå Unexpected file in root: $file"
              echo "   ‚Üí Should be moved to appropriate subfolder"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done

          # Report results
          if [ $VIOLATIONS -gt 0 ]; then
            echo ""
            echo "‚ùå Found $VIOLATIONS structure violations!"
            echo ""
            echo "üìÅ Correct structure:"
            echo "   ‚Ä¢ Documentation ‚Üí docs/"
            echo "   ‚Ä¢ Config files ‚Üí config/"
            echo "   ‚Ä¢ Scripts ‚Üí scripts/"
            echo "   ‚Ä¢ Logs ‚Üí logs/"
            echo "   ‚Ä¢ Source code ‚Üí src/"
            echo ""
            echo "Run: ./scripts/cleanup.sh to organize files"
            exit 1
          else
            echo "‚úÖ Repository structure is clean!"
          fi
