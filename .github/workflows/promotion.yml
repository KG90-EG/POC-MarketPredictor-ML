name: Model Promotion

on:
  schedule:
    - cron: '0 4 * * *'  # daily 4:00 UTC
  workflow_dispatch:

jobs:
  evaluate_promote:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install training requirements
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r training/requirements.txt
          python -m pip install boto3  # For S3 upload (optional)
      - name: Run drift check
        run: |
          python training/drift_check.py --tickers AAPL,MSFT,NVDA || echo "::warning::Drift check failed or detected drift, continuing with training"
      - name: Train new model
        run: |
          python training/trainer.py
      - name: Evaluate and Promote
        run: |
          NEWMODEL=$(ls -t models/model_*.bin 2>/dev/null | head -n1)
          if [ -z "$NEWMODEL" ]; then
            echo "::error::No new model found to evaluate"
            exit 1
          fi
          python training/evaluate_and_promote.py --new-model "$NEWMODEL" --prod-model models/prod_model.bin --tickers AAPL,MSFT,NVDA
      - name: Upload prod model to S3 (optional)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          if [ -n "${AWS_ACCESS_KEY_ID}" ] && [ -n "${AWS_SECRET_ACCESS_KEY}" ] && [ -n "${S3_BUCKET}" ]; then
            python -m pip install boto3
            python scripts/push_model_to_s3.py --file models/prod_model.bin --bucket "${S3_BUCKET}" --key models/prod_model.bin
          else
            echo "::notice::AWS credentials or S3_BUCKET not configured; skipping upload. See SECRETS.md for setup."
          fi
