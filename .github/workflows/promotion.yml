name: Model Promotion

on:
  schedule:
    - cron: '0 4 * * *'  # daily 4:00 UTC
  workflow_dispatch:

jobs:
  evaluate_promote:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install training requirements
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r training/requirements.txt
      - name: Run drift check
        run: |
          python training/drift_check.py --tickers AAPL,MSFT,NVDA || true
      - name: Train new model
        run: |
          python training/trainer.py
      - name: Evaluate and Promote
        run: |
          NEWMODEL=$(ls models | sort -r | head -n1)
          python training/evaluate_and_promote.py --new-model models/$NEWMODEL --prod-model models/prod_model.bin --tickers AAPL,MSFT,NVDA
      - name: Upload prod model to S3 (optional)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          if [ -n "${AWS_ACCESS_KEY_ID}" ]; then
            python scripts/push_model_to_s3.py --file models/prod_model.bin --bucket ${{ secrets.S3_BUCKET }} --key models/prod_model.bin
          else
            echo "No AWS credentials provided; skipping upload"
          fi
