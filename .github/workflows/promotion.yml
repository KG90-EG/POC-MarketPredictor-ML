name: Model Promotion

# Optional GitHub Secrets for S3 model storage (see GITHUB_SECRETS.md):
#   - AWS_ACCESS_KEY_ID: AWS IAM access key (optional)
#   - AWS_SECRET_ACCESS_KEY: AWS IAM secret key (optional)
#   - S3_BUCKET: S3 bucket name for model artifacts (optional)
# Note: S3 storage is optional. Models can be stored locally without these secrets.
# Setup guide: https://github.com/KG90-EG/POC-MarketPredictor-ML/blob/main/GITHUB_SECRETS.md

on:
  schedule:
    - cron: '0 4 * * *'  # daily 4:00 UTC
  workflow_dispatch:

jobs:
  evaluate_promote:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      - name: Install training requirements
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install -r src/training/requirements.txt
          python -m pip install boto3  # For S3 upload (optional)
      - name: Run drift check (if available)
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          if [ -f "src/training/drift_check.py" ]; then
            python src/training/drift_check.py --tickers AAPL,MSFT,NVDA || \
              echo "::warning::Drift check failed or detected drift, continuing"
          else
            echo "::notice::drift_check.py not found, skipping"
          fi
      - name: Train new model (if available)
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          if [ -f "src/training/trainer.py" ]; then
            python src/training/trainer.py || \
              echo "::warning::Training failed, may be due to insufficient data or network issues"
          else
            echo "::notice::trainer.py not found, skipping"
          fi
      - name: Evaluate and Promote (if available)
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          if [ ! -f "src/training/evaluate_and_promote.py" ]; then
            echo "::notice::evaluate_and_promote.py not found, skipping model promotion"
            exit 0
          fi
          NEWMODEL=$(ls -t models/model_*.bin 2>/dev/null | head -n1)
          if [ -z "$NEWMODEL" ]; then
            echo "::warning::No new model found to evaluate"
            exit 0
          fi
          python src/training/evaluate_and_promote.py \
            --new-model "$NEWMODEL" \
            --prod-model models/prod_model.bin \
            --tickers AAPL,MSFT,NVDA || \
            echo "::warning::Model evaluation failed"
      - name: Upload prod model to S3 (optional)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          if [ -n "${AWS_ACCESS_KEY_ID}" ] && [ -n "${AWS_SECRET_ACCESS_KEY}" ] && [ -n "${S3_BUCKET}" ]; then
            python -m pip install boto3
            python scripts/push_model_to_s3.py --file models/prod_model.bin --bucket "${S3_BUCKET}" --key models/prod_model.bin
          else
            echo "::notice::AWS credentials or S3_BUCKET not configured; skipping upload. See SECRETS.md for setup."
          fi
