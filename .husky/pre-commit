#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any check fails
CHECKS_FAILED=0

# 1. Python linting
echo "\n${YELLOW}Running Python linting...${NC}"
if command -v flake8 >/dev/null 2>&1; then
    if flake8 src/trading_engine/ src/backtest/ scripts/ \
        --max-line-length=100 \
        --extend-ignore=C901,E203,W503,F401,F811,F541,W293,E501,D100,D101,D102,D103,D104,D105,D107,D200,D205,D400,D401,D403,E731 \
        --count --statistics 2>&1 | grep -v "^0$" > /dev/null; then
        echo "${RED}âœ— Flake8 found issues${NC}"
        CHECKS_FAILED=1
    else
        echo "${GREEN}âœ“ Flake8 passed${NC}"
    fi
else
    echo "${YELLOW}âš  flake8 not installed, skipping${NC}"
fi

# 2. Python formatting check
echo "\n${YELLOW}Checking Python formatting...${NC}"
if command -v black >/dev/null 2>&1; then
    if ! black --check --line-length=100 src/trading_engine/ src/backtest/ scripts/ >/dev/null 2>&1; then
        echo "${RED}âœ— Black formatting issues found${NC}"
        echo "${YELLOW}Run 'black --line-length=100 src/trading_engine/ src/backtest/ scripts/' to fix${NC}"
        CHECKS_FAILED=1
    else
        echo "${GREEN}âœ“ Black formatting OK${NC}"
    fi
else
    echo "${YELLOW}âš  black not installed, skipping${NC}"
fi

# 3. Python tests (quick smoke test)
echo "\n${YELLOW}Running Python tests...${NC}"
if command -v pytest >/dev/null 2>&1; then
    if ! python -m pytest tests/ \
        --ignore=tests/phase1/ \
        --ignore=tests/phase2/ \
        --ignore=tests/test_crypto.py \
        --ignore=tests/test_integration.py \
        -k "not (test_ranking or test_predict)" \
        -x -q --tb=line >/dev/null 2>&1; then
        echo "${RED}âœ— Tests failed${NC}"
        CHECKS_FAILED=1
    else
        echo "${GREEN}âœ“ Tests passed${NC}"
    fi
else
    echo "${YELLOW}âš  pytest not installed, skipping${NC}"
fi

# 4. Frontend linting (if npm is available)
if [ -d "frontend" ]; then
    echo "\n${YELLOW}Checking frontend...${NC}"
    cd frontend
    
    if command -v npm >/dev/null 2>&1; then
        # Check if node_modules exists
        if [ -d "node_modules" ]; then
            if ! npm run lint >/dev/null 2>&1; then
                echo "${RED}âœ— ESLint found issues${NC}"
                CHECKS_FAILED=1
            else
                echo "${GREEN}âœ“ ESLint passed${NC}"
            fi
            
            if ! npm run format:check >/dev/null 2>&1; then
                echo "${RED}âœ— Prettier formatting issues${NC}"
                echo "${YELLOW}Run 'npm run format' to fix${NC}"
                CHECKS_FAILED=1
            else
                echo "${GREEN}âœ“ Prettier formatting OK${NC}"
            fi
        else
            echo "${YELLOW}âš  node_modules not found, run 'npm install'${NC}"
        fi
    else
        echo "${YELLOW}âš  npm not installed, skipping frontend checks${NC}"
    fi
    
    cd ..
fi

# 5. Check for large files
echo "\n${YELLOW}Checking for large files...${NC}"
LARGE_FILES=$(git diff --cached --name-only | xargs -I {} sh -c 'if [ -f "{}" ]; then stat -f%z "{}"; fi' 2>/dev/null | awk '$1 > 52428800 {print}')
if [ -n "$LARGE_FILES" ]; then
    echo "${RED}âœ— Large files detected (>50MB)${NC}"
    git diff --cached --name-only | while read file; do
        if [ -f "$file" ]; then
            SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
            if [ "$SIZE" -gt 52428800 ]; then
                echo "${RED}  - $file ($(($SIZE / 1024 / 1024))MB)${NC}"
            fi
        fi
    done
    CHECKS_FAILED=1
else
    echo "${GREEN}âœ“ No large files${NC}"
fi

# Summary
echo "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ $CHECKS_FAILED -eq 0 ]; then
    echo "${GREEN}âœ“ All pre-commit checks passed!${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
    exit 0
else
    echo "${RED}âœ— Some checks failed${NC}"
    echo "${YELLOW}Fix the issues above or use 'git commit --no-verify' to skip${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
    exit 1
fi
